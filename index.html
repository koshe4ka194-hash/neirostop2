<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuro-Stop 3D Extension</title>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: transparent;
            font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', 'Segoe UI', sans-serif; /* –ë–æ–ª–µ–µ –¥–µ—Ç—Å–∫–∏–π —à—Ä–∏—Ñ—Ç */
        }

        #app-container {
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex; justify-content: center; align-items: center;
            transition: background-color 0.5s ease;
            perspective: 1000px; /* –î–ª—è 3D —ç—Ñ—Ñ–µ–∫—Ç–∞ */
        }

        #app-container.paused {
            pointer-events: all;
            background-color: rgba(40, 30, 60, 0.4); /* –ú—è–≥–∫–æ–µ —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
            backdrop-filter: blur(3px);
        }

        /* --- –ù–û–í–´–ô 3D –í–ò–ó–£–ê–õ –ö–ê–†–¢–û–ß–ö–ò --- */
        .pause-card-wrap {
            opacity: 0;
            transform: rotateX(20deg) translateZ(-100px); /* –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä—É–∂–∏–Ω—ã –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ */
            transform-style: preserve-3d;
            display: none;
        }

        #app-container.paused .pause-card-wrap {
            display: block;
            opacity: 1;
            transform: rotateX(0deg) translateZ(0); /* –ö–æ–Ω–µ—á–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è */
        }

        .pause-card {
            background: linear-gradient(135deg, #ffffff 0%, #f0f4f8 100%);
            padding: 40px 30px;
            border-radius: 30px;
            text-align: center;
            max-width: 85%; width: 380px;
            /* 3D –æ–±—ä–µ–º –∏ —Å–≤–µ—á–µ–Ω–∏–µ */
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.15), /* –ì–ª—É–±–æ–∫–∞—è —Ç–µ–Ω—å */
                0 0 20px rgba(100, 180, 255, 0.4), /* –í–Ω–µ—à–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
                inset 0 0 20px rgba(255,255,255,0.8); /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–ª–∏–∫ */
            border: 3px solid rgba(255, 255, 255, 0.7);
            position: relative;
            overflow: hidden;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –±–ª–∏–∫–∞ —Å–≤–µ—Ç–∞ */
        .pause-card::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(to bottom right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0) 100%);
            transform: rotate(45deg);
            animation: shineEffect 3s infinite ease-in-out;
            pointer-events: none;
        }
        @keyframes shineEffect {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .pause-icon {
            font-size: 50px; margin-bottom: 15px;
            text-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }

        .pause-text {
            font-size: 20px; color: #444; margin-bottom: 25px;
            line-height: 1.5; font-weight: bold;
        }

        .timer-wrapper {
            display: none; /* –°–∫—Ä—ã—Ç –≤ —Ñ–∞–∑–µ 1 (10 —Å–µ–∫) */
        }

        .timer-label {
             font-size: 14px; color: #666; margin-bottom: 5px; display: block;
        }

        .timer-display {
            font-size: 56px; font-weight: 800; color: #FF9F43; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π */
            font-variant-numeric: tabular-nums;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div class="pause-card-wrap">
            <div class="pause-card">
                <div class="pause-icon">üßò‚ú®</div>
                <div class="pause-text" id="pause-text">
                    –û–π! –ö–∞–∂–µ—Ç—Å—è, –Ω–∞—à–∏–º –≥–ª–∞–∑–∫–∞–º –∏ –ø–∞–ª—å—á–∏–∫–∞–º –ø–æ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å –º–∞–ª–µ–Ω—å–∫—É—é –∑–∞—Ä—è–¥–∫—É. –ì–æ—Ç–æ–≤?
                </div>
                
                <div class="timer-wrapper" id="timer-block">
                    <span class="timer-label">–í—ã–ø–æ–ª–Ω—è–π –∑–∞–¥–∞–Ω–∏–µ:</span>
                    <div class="timer-display" id="timer">60</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ü–ê–†–ê–ú–ï–¢–†–´
         */
        const params = new URLSearchParams(window.location.search);
        const config = {
            interactionEvery: parseInt(params.get('interactionEvery')) || 5,
            activeMinutes: parseFloat(params.get('activeMinutes')) || 5,
            idleTimeout: parseInt(params.get('idleTimeout')) || 20,
            // –¢–µ–∫—Å—Ç —Ç–µ–ø–µ—Ä—å –∑–∞—à–∏—Ç –≤ HTML, –Ω–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
            phrasePhase1: params.get('text') || "–û–π! –ö–∞–∂–µ—Ç—Å—è, –Ω–∞—à–∏–º –≥–ª–∞–∑–∫–∞–º –∏ –ø–∞–ª—å—á–∏–∫–∞–º –ø–æ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å –º–∞–ª–µ–Ω—å–∫—É—é –∑–∞—Ä—è–¥–∫—É. –ì–æ—Ç–æ–≤?",
            phrasePhase2: "–û—Ç–ª–∏—á–Ω–æ! –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∏–≥—Ä—É —á–µ—Ä–µ–∑:",
            // –ù–û–í–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ –î–õ–Ø –õ–û–ì–ò–ö–ò –ü–ï–†–ï–•–û–î–û–í
            preSwitchDelay: 10, // –§–∞–∑–∞ 1: —Å–µ–∫—É–Ω–¥ –¥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –Ω–µ–π—Ä–æ—Å–ª–∞–π–¥
            neuroTaskDuration: 60, // –§–∞–∑–∞ 2: —Å–µ–∫—É–Ω–¥ –Ω–∞ –Ω–µ–π—Ä–æ—Å–ª–∞–π–¥–µ
            // ID —Å–ª–∞–π–¥–æ–≤ (–∑–∞–¥–∞—é—Ç—Å—è –≤ URL: ?neuroSlide=XXXX&returnSlide=YYYY)
            neuroSlideId: params.get('neuroSlide') || null, 
            returnSlideId: params.get('returnSlide') || null 
        };

        // DOM –≠–ª–µ–º–µ–Ω—Ç—ã
        const container = document.getElementById('app-container');
        const textEl = document.getElementById('pause-text');
        const timerBlockEl = document.getElementById('timer-block');
        const timerEl = document.getElementById('timer');

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let state = {
            clickCount: 0, activeSeconds: 0, lastActivityTime: Date.now(),
            isPaused: false, isIdle: false,
            currentPhase: 'running' // running, phase1_preparing, phase2_task
        };
        let activeTimerInterval, phaseTimerInterval;

        // --- –§–£–ù–ö–¶–ò–ò-–ó–ê–ì–õ–£–®–ö–ò –î–õ–Ø GENIALLY API (–í–ê–ñ–ù–û!) ---
        
        // –§—É–Ω–∫—Ü–∏—è 1: –ü–µ—Ä–µ—Ö–æ–¥ –ù–ê —Å–ª–∞–π–¥ —Å –∑–∞–¥–∞–Ω–∏–µ–º
        function executeSlideSwitch(targetSlideId) {
            if (!targetSlideId) {
                console.warn("‚ö†Ô∏è –ù–µ —É–∫–∞–∑–∞–Ω ID –Ω–µ–π—Ä–æ-—Å–ª–∞–π–¥–∞ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö URL (neuroSlide=...)");
                return;
            }
            console.log(`%cüí° GENIALLY API: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–µ–π—Ä–æ-—Å–ª–∞–π–¥ ID: ${targetSlideId}`, 'color: chartreuse; background: #333; padding: 4px;');
            
            /* TODO: –í–°–¢–ê–í–ò–¢–¨ –°–Æ–î–ê –†–ï–ê–õ–¨–ù–´–ô –ö–û–î GENIALLY API */
            // –ù–∞–ø—Ä–∏–º–µ—Ä: window.parent.postMessage({ type: 'goto', slide: targetSlideId }, '*');
        }

        // –§—É–Ω–∫—Ü–∏—è 2: –í–æ–∑–≤—Ä–∞—Ç –ù–ê –∏—Å—Ö–æ–¥–Ω—ã–π —Å–ª–∞–π–¥
        function executeReturnSwitch(targetSlideId) {
             if (!targetSlideId) {
                 console.warn("‚ö†Ô∏è –ù–µ —É–∫–∞–∑–∞–Ω ID —Å–ª–∞–π–¥–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö URL (returnSlide=...)");
                 // –ï—Å–ª–∏ ID –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–µ –∑–∞–¥–∞–Ω, –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
                 endPauseSequence();
                 return;
            }
            console.log(`%cüí° GENIALLY API: –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Å–ª–∞–π–¥ –∏–≥—Ä—ã ID: ${targetSlideId}`, 'color: cyan; background: #333; padding: 4px;');

            /* TODO: –í–°–¢–ê–í–ò–¢–¨ –°–Æ–î–ê –†–ï–ê–õ–¨–ù–´–ô –ö–û–î GENIALLY API */
            
            // –ü–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã –≤–æ–∑–≤—Ä–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø–∞—É–∑—É
            endPauseSequence();
        }


        // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ü–ê–£–ó–´ (2 –§–ê–ó–´) ---

        function triggerPause(reason) {
            if(state.isPaused) return;
            console.log(`Sequence started: ${reason}`);
            state.isPaused = true;
            
            // –°–±—Ä–æ—Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
            state.clickCount = 0; state.activeSeconds = 0;

            // --- –§–ê–ó–ê 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (10 —Å–µ–∫—É–Ω–¥) ---
            state.currentPhase = 'phase1_preparing';
            
            // –í–∏–∑—É–∞–ª –§–ê–ó–´ 1
            textEl.textContent = config.phrasePhase1;
            timerBlockEl.style.display = 'none'; // –¢–∞–π–º–µ—Ä 60—Å –ø–æ–∫–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            container.classList.add('paused');

            console.log(`Phase 1: Waiting ${config.preSwitchDelay}s before switch...`);

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–∂–∏–¥–∞–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ (10 —Å–µ–∫)
            setTimeout(() => {
                startPhase2();
            }, config.preSwitchDelay * 1000);
        }

        function startPhase2() {
            // --- –§–ê–ó–ê 2: –ü–µ—Ä–µ—Ö–æ–¥ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è (60 —Å–µ–∫—É–Ω–¥) ---
            state.currentPhase = 'phase2_task';
            console.log("Phase 2: Switching slide & starting 60s timer.");

            // 1. –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω ID)
            executeSlideSwitch(config.neuroSlideId);

            // 2. –ú–µ–Ω—è–µ–º –≤–∏–∑—É–∞–ª –∫–∞—Ä—Ç–æ—á–∫–∏ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–Ω–∞ –≤—Å–µ –µ—â–µ –≤–∏–¥–Ω–∞ –Ω–∞ –Ω–æ–≤–æ–º —Å–ª–∞–π–¥–µ)
            textEl.textContent = config.phrasePhase2;
            timerBlockEl.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            
            let timeLeft = config.neuroTaskDuration;
            timerEl.textContent = timeLeft;

            if (phaseTimerInterval) clearInterval(phaseTimerInterval);

            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç 60 —Å–µ–∫
            phaseTimerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                console.log("Task timer: " + timeLeft);

                if (timeLeft <= 0) {
                    clearInterval(phaseTimerInterval);
                    // –í—Ä–µ–º—è –≤—ã—à–ª–æ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è
                    executeReturnSwitch(config.returnSlideId);
                }
            }, 1000);
        }

        function endPauseSequence() {
            console.log("Sequence finished. Resuming game.");
            state.isPaused = false;
            state.currentPhase = 'running';
            state.lastActivityTime = Date.now();
            container.classList.remove('paused');
        }


        // --- –°–¢–ê–ù–î–ê–†–¢–ù–ê–Ø –õ–û–ì–ò–ö–ê –¢–†–ò–ì–ì–ï–†–û–í (–ò–∑ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏) ---

        function registerActivity() {
            if (state.isPaused) return;
            state.isIdle = false;
            state.lastActivityTime = Date.now();

            if (config.interactionEvery > 0) {
                state.clickCount++;
                if (state.clickCount >= config.interactionEvery) triggerPause('clicks');
            }
        }

        function startActiveTimer() {
            if (activeTimerInterval) clearInterval(activeTimerInterval);
            activeTimerInterval = setInterval(() => {
                if (state.isPaused || state.isIdle) return;
                
                if ((Date.now() - state.lastActivityTime) / 1000 > config.idleTimeout) {
                    state.isIdle = true; return;
                }

                if (config.activeMinutes > 0) {
                    state.activeSeconds++;
                    if (state.activeSeconds >= (config.activeMinutes * 60)) triggerPause('time');
                }
            }, 1000);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π (Hybrid approach)
        try {
            window.parent.document.addEventListener('click', registerActivity, { capture: true });
        } catch (e) {
            document.addEventListener('click', registerActivity);
            document.addEventListener('touchstart', registerActivity);
            document.addEventListener('keydown', registerActivity);
        }
        
        startActiveTimer();

    </script>
</body>
</html>
